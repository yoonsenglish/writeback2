<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>윤선생 리얼스피치 WriteBack</title>
    <link rel="icon" href="data:," />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />
    <style>
        /* --- 기본 스타일 및 레이아웃 --- */
        body {
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8fafc;
            margin: 0;
            padding: 2.5rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            line-height: 1.6;
            color: #334155;
        }

        #container {
            width: 100%;
            max-width: 768px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
            position: relative;
            z-index: 1;
        }

        h1 {
            font-size: 2.25rem;
            color: #1e293b;
            text-align: center;
            margin-bottom: 2.5rem;
            font-weight: 700;
        }

        h2 {
            font-size: 1.5rem;
            color: #334155;
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .section {
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 2rem;
            margin-bottom: 2rem;
        }

        .section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        /* --- 파일 업로드 섹션 --- */
        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 2.5rem;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            margin-bottom: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px;
        }

        .upload-area:hover {
            background-color: #f0f4f8;
            border-color: #a0aec0;
        }

        .upload-icon {
            font-size: 3rem;
            color: #64748b;
            margin-bottom: 1rem;
        }

        .upload-area p {
            margin: 0.5rem 0;
            color: #64748b;
            font-size: 1rem;
        }

        .file-name {
            font-weight: 600;
            color: #334155;
        }

        #image-upload {
            display: none;
        }

        #image-preview-container {
            margin-top: 1.5rem;
            text-align: center;
            background-color: #f0f4f8;
            border-radius: 8px;
            padding: 1rem;
            display: none; /* 초기 숨김 */
        }

        #image-preview {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-height: 300px;
            object-fit: contain;
        }

        .image-tools {
            margin-top: 1rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        .image-tool-btn {
            background-color: #4f46e5;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s ease-in-out;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .image-tool-btn:hover {
            background-color: #4338ca;
        }

        /* --- 텍스트 영역 및 버튼 --- */
        textarea {
            width: 100%;
            padding: 1rem;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            line-height: 1.5;
            min-height: 100px;
            resize: vertical;
            box-sizing: border-box; /* 패딩이 너비에 포함되도록 */
            background-color: #ffffff;
            color: #334155;
            margin-bottom: 1.5rem;
            font-family: inherit;
        }

        textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .button-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
            flex-wrap: wrap; /* 작은 화면에서 버튼이 줄바꿈 되도록 */
        }

        .btn {
            background-color: #4f46e5;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            font-weight: 600;
        }

        .btn:hover:not(:disabled) {
            background-color: #4338ca;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
        }

        .btn.btn-secondary {
            background-color: #64748b;
        }

        .btn.btn-secondary:hover:not(:disabled) {
            background-color: #475569;
        }

        .btn.btn-red {
            background-color: #dc2626;
        }

        .btn.btn-red:hover:not(:disabled) {
            background-color: #b91c1c;
        }

        /* --- 스피너 --- */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
            display: none; /* 기본 숨김 */
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* --- 피드백 섹션 --- */
        #feedback-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        #feedback-result-container {
            background-color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 8px;
            color: #334155;
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 1.5rem;
            display: none; /* 초기 숨김 */
        }

        /* --- 인쇄 옵션 --- */
        .print-options {
            background-color: #f0f4f8;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.5rem;
            display: none; /* 초기 숨김 */
            flex-direction: column;
            gap: 1rem;
        }

        .print-options h3 {
            margin-top: 0;
            color: #334155;
            font-size: 1.25rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .print-checkbox-group {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
        }

        .print-checkbox-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            color: #334155;
        }

        .print-checkbox-group input[type="checkbox"] {
            transform: scale(1.2);
            accent-color: #4f46e5;
        }

        .print-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .print-input-group label {
            font-weight: 600;
            color: #334155;
            font-size: 0.95rem;
        }

        .print-input-group input[type="text"] {
            padding: 0.8rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 1rem;
            color: #334155;
        }

        /* 반응형 디자인 */
        @media (max-width: 600px) {
            body {
                padding: 1rem;
            }

            #container {
                padding: 1.5rem;
            }

            h1 {
                font-size: 1.8rem;
            }

            h2 {
                font-size: 1.3rem;
            }

            .upload-area {
                padding: 1.5rem;
            }

            .upload-icon {
                font-size: 2.5rem;
            }

            .btn {
                padding: 0.7rem 1.2rem;
                font-size: 1rem;
            }

            .button-group {
                flex-direction: column;
                gap: 0.8rem;
            }

            .image-tool-btn {
                padding: 0.5rem 1rem;
                font-size: 0.85rem;
            }
        }
    </style>
</head>

<body>
    <div id="container">
        <h1>
            <span style="color: #4f46e5">윤선생</span> 리얼스피치 WriteBack
        </h1>

        <div class="section">
            <h2><i class="fas fa-image"></i> 이미지 업로드</h2>
            <div class="upload-area" id="upload-area">
                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                <p>여기에 파일을 드래그하거나 클릭하여 업로드하세요</p>
                <p class="file-name" id="file-name-display"></p>
                <input type="file" id="image-upload" accept="image/*" />
            </div>
            <div id="image-preview-container">
                <img id="image-preview" src="#" alt="미리보기" />
                <div class="image-tools">
                    <button id="rotate-left-btn" class="image-tool-btn">
                        <i class="fas fa-undo"></i> 좌측 회전
                    </button>
                    <button id="rotate-right-btn" class="image-tool-btn">
                        <i class="fas fa-redo"></i> 우측 회전
                    </button>
                    <button id="reset-rotation-btn" class="image-tool-btn">
                        <i class="fas fa-sync-alt"></i> 회전 초기화
                    </button>
                </div>
            </div>
        </div>

        <div class="section">
            <h2><i class="fas fa-font"></i> OCR 인식 결과</h2>
            <textarea id="ocr-result" placeholder="여기에 OCR 인식 결과가 표시됩니다." readonly></textarea>
            <div class="button-group">
                <button id="do-ocr-btn" class="btn">
                    <span class="spinner" id="ocr-spinner"></span>
                    <i class="fas fa-search"></i> OCR 인식
                </button>
                <button id="edit-ocr-btn" class="btn btn-secondary">
                    <i class="fas fa-edit"></i> OCR 결과 편집
                </button>
                <button id="reset-ocr-btn" class="btn btn-red">
                    <i class="fas fa-times"></i> OCR 초기화
                </button>
            </div>
            <div class="print-options" id="print-options-ocr">
                <h3>인쇄 옵션 (OCR 결과)</h3>
                <div class="print-checkbox-group">
                    <label>
                        <input type="checkbox" id="print_orig_ocr" checked /> 원본 이미지
                    </label>
                    <label>
                        <input type="checkbox" id="print_ocr" checked /> OCR 텍스트
                    </label>
                </div>
                <div class="print-input-group">
                    <label for="user-name-ocr">이름:</label>
                    <input type="text" id="user-name-ocr" placeholder="이름을 입력하세요" />
                </div>
                <div class="print-input-group">
                    <label for="user-school-ocr">학교:</label>
                    <input type="text" id="user-school-ocr" placeholder="학교를 입력하세요" />
                </div>
                <div class="button-group">
                    <button id="confirm-print-ocr-btn" class="btn">
                        <i class="fas fa-print"></i> 인쇄
                    </button>
                </div>
            </div>
            <div class="button-group" style="margin-top: 1.5rem;">
                <button id="print-ocr-btn" class="btn btn-secondary">
                    <i class="fas fa-print"></i> 인쇄하기
                </button>
            </div>
        </div>

        <div class="section">
            <h2><i class="fas fa-magic"></i> 최종 결과물 생성</h2>
            <p style="color: #64748b; font-size: 0.95rem; margin-bottom: 1rem;">
                원본 이미지와 OCR 인식 결과를 바탕으로 최종 문맥에 맞는 교정/생성 지시를 내려주세요. (예: "띄어쓰기만 교정해줘", "문법 오류를 고쳐줘", "어색한 부분을 자연스럽게 바꿔줘")
            </p>
            <textarea id="correction-prompt" placeholder="교정/생성 지시를 입력하세요 (선택 사항)" style="min-height: 80px;"></textarea>
            <textarea id="final-result" placeholder="여기에 최종 교정된 결과가 표시됩니다." readonly></textarea>
            <div class="button-group">
                <button id="submit-final-btn" class="btn">
                    <span class="spinner" id="submit-spinner-final"></span>
                    <i class="fas fa-check-circle"></i> 최종 결과물 생성
                </button>
            </div>
            <div class="print-options" id="print-options-final">
                <h3>인쇄 옵션 (최종 결과물)</h3>
                <div class="print-checkbox-group">
                    <label>
                        <input type="checkbox" id="print_orig_final" checked /> 원본 이미지
                    </label>
                    <label>
                        <input type="checkbox" id="print_corr_final" checked /> 교정된 텍스트
                    </label>
                </div>
                <div class="print-input-group">
                    <label for="user-name-final">이름:</label>
                    <input type="text" id="user-name-final" placeholder="이름을 입력하세요" />
                </div>
                <div class="print-input-group">
                    <label for="user-school-final">학교:</label>
                    <input type="text" id="user-school-final" placeholder="학교를 입력하세요" />
                </div>
                <div class="button-group">
                    <button id="confirm-print-final-btn" class="btn">
                        <i class="fas fa-print"></i> 인쇄
                    </button>
                </div>
            </div>
            <div class="button-group" style="margin-top: 1.5rem;">
                <button id="print-final-btn" class="btn btn-secondary">
                    <i class="fas fa-print"></i> 인쇄하기
                </button>
            </div>
        </div>

        <div class="section">
            <h2><i class="fas fa-comment"></i> 피드백</h2>
            <textarea id="feedback-text" placeholder="이용 경험에 대한 피드백을 남겨주세요."></textarea>
            <button id="submit-feedback-btn" class="btn">
                <span class="spinner" id="feedback-spinner"></span>
                <i class="fas fa-paper-plane"></i> 피드백 제출
            </button>
            <div id="feedback-result-container">
                <p id="feedback-result-message"></p>
            </div>
        </div>
    </div>

    <script>
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('image-upload');
        const fileNameDisplay = document.getElementById('file-name-display');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const rotateLeftBtn = document.getElementById('rotate-left-btn');
        const rotateRightBtn = document.getElementById('rotate-right-btn');
        const resetRotationBtn = document.getElementById('reset-rotation-btn');
        let currentRotation = 0;
        let originalImageUrl = ''; // 원본 URL (Blob 또는 Data URL)
        let originalBase64Image = ''; // Base64 인코딩된 원본 이미지 데이터 (헤더 제외)
        let originalMimeType = ''; // 원본 이미지 MIME 타입

        const ocrResultTextarea = document.getElementById('ocr-result');
        const doOcrBtn = document.getElementById('do-ocr-btn');
        const ocrSpinner = document.getElementById('ocr-spinner');
        const editOcrBtn = document.getElementById('edit-ocr-btn');
        const resetOcrBtn = document.getElementById('reset-ocr-btn');

        const finalResultTextarea = document.getElementById('final-result');
        const submitFinalBtn = document.getElementById('submit-final-btn');
        const submitSpinnerFinal = document.getElementById('submit-spinner-final');
        const correctionPromptTextarea = document.getElementById('correction-prompt'); // 새롭게 추가된 프롬프트 입력창

        const feedbackTextarea = document.getElementById('feedback-text');
        const submitFeedbackBtn = document.getElementById('submit-feedback-btn');
        const feedbackSpinner = document.getElementById('feedback-spinner');
        const feedbackResultMessage = document.getElementById('feedback-result-message');
        const feedbackResultContainer = document.getElementById('feedback-result-container');

        const printOcrBtn = document.getElementById('print-ocr-btn');
        const printOptionsOcr = document.getElementById('print-options-ocr');
        const confirmPrintOcrBtn = document.getElementById('confirm-print-ocr-btn');

        const printFinalBtn = document.getElementById('print-final-btn');
        const printOptionsFinal = document.getElementById('print-options-final');
        const confirmPrintFinalBtn = document.getElementById('confirm-print-final-btn');

        // 이미지 파일 선택 또는 드래그앤드롭 처리
        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFiles);
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e);
        });

        async function handleFiles(event) {
            const files = event.dataTransfer ? event.dataTransfer.files : event.target.files;
            if (files.length === 0) return;

            const file = files[0];
            fileNameDisplay.textContent = file.name;
            originalMimeType = file.type; // MIME 타입 저장

            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                originalImageUrl = e.target.result; // Data URL 저장 (인쇄용)
                originalBase64Image = e.target.result.split(',')[1]; // Base64 데이터만 저장 (API 전송용)
                imagePreviewContainer.style.display = 'block';
                currentRotation = 0; // 새 이미지 업로드 시 회전 초기화
                imagePreview.style.transform = `rotate(0deg)`;
                ocrResultTextarea.value = ''; // OCR 결과 초기화
                finalResultTextarea.value = ''; // 최종 결과물 초기화
                correctionPromptTextarea.value = ''; // 교정 프롬프트 초기화
            };
            reader.readAsDataURL(file);
        }

        // 이미지 회전 기능
        rotateLeftBtn.addEventListener('click', () => {
            currentRotation = (currentRotation - 90) % 360;
            imagePreview.style.transform = `rotate(${currentRotation}deg)`;
        });

        rotateRightBtn.addEventListener('click', () => {
            currentRotation = (currentRotation + 90) % 360;
            imagePreview.style.transform = `rotate(${currentRotation}deg)`;
        });

        resetRotationBtn.addEventListener('click', () => {
            currentRotation = 0;
            imagePreview.style.transform = `rotate(0deg)`;
        });

        // OCR 인식 버튼 클릭
        doOcrBtn.addEventListener('click', async () => {
            if (!imagePreview.src || imagePreview.src === '#') {
                alert('먼저 이미지를 업로드해주세요.');
                return;
            }

            doOcrBtn.disabled = true;
            ocrSpinner.style.display = 'block';
            ocrResultTextarea.value = 'OCR 인식 중...';

            try {
                // 현재 회전 상태를 반영한 이미지 데이터 생성 (Canvas를 통해 회전된 이미지의 Base64)
                const rotatedCanvas = document.createElement('canvas');
                const img = new Image();
                img.src = imagePreview.src;
                await new Promise(resolve => img.onload = resolve); // 이미지 로드 대기

                const rotationInRadians = currentRotation * Math.PI / 180;
                let rotatedWidth = img.naturalWidth;
                let rotatedHeight = img.naturalHeight;

                if (currentRotation % 180 !== 0) { // 90도 또는 270도 회전 시 너비/높이 교환
                    rotatedWidth = img.naturalHeight;
                    rotatedHeight = img.naturalWidth;
                }

                rotatedCanvas.width = rotatedWidth;
                rotatedCanvas.height = rotatedHeight;
                const ctx = rotatedCanvas.getContext('2d');
                ctx.translate(rotatedWidth / 2, rotatedHeight / 2);
                ctx.rotate(rotationInRadians);
                ctx.drawImage(img, -img.naturalWidth / 2, -img.naturalHeight / 2);
                
                const rotatedImageBase64 = rotatedCanvas.toDataURL(originalMimeType);
                
                // 프록시 서버로 OCR 요청
                const response = await fetch('/proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image: rotatedImageBase64.split(',')[1], // Base64 데이터만 전송
                        mimeType: originalMimeType,
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '알 수 없는 서버 오류');
                }

                const data = await response.json();
                ocrResultTextarea.value = data.extractedText;
                ocrResultTextarea.readOnly = true; // OCR 후에는 읽기 전용으로

            } catch (e) {
                ocrResultTextarea.value = 'OCR 오류: ' + e.message;
                alert('OCR 인식 중 오류가 발생했습니다: ' + e.message);
            } finally {
                doOcrBtn.disabled = false;
                ocrSpinner.style.display = 'none';
            }
        });

        // OCR 결과 편집 버튼
        editOcrBtn.addEventListener('click', () => {
            ocrResultTextarea.readOnly = false;
            ocrResultTextarea.focus();
        });

        // OCR 초기화 버튼
        resetOcrBtn.addEventListener('click', () => {
            ocrResultTextarea.value = '';
            ocrResultTextarea.readOnly = true;
        });

        // 최종 결과물 생성 버튼 클릭
        submitFinalBtn.addEventListener('click', async () => {
            const ocrText = ocrResultTextarea.value.trim();
            if (!ocrText) {
                alert('먼저 OCR 인식을 수행하거나 텍스트를 입력해주세요.');
                return;
            }
            if (!originalBase64Image || !originalMimeType) {
                alert('원본 이미지가 업로드되지 않았습니다.');
                return;
            }

            submitFinalBtn.disabled = true;
            submitSpinnerFinal.style.display = 'block';
            finalResultTextarea.value = '최종 결과물 생성 중...';

            try {
                const instructionPrompt = correctionPromptTextarea.value.trim();

                const response = await fetch('/api/generate-final-result', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ocrText: ocrText,
                        originalImageBase64: originalBase64Image, // 원본 Base64 데이터 전송
                        mimeType: originalMimeType,
                        instructionPrompt: instructionPrompt
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '알 수 없는 서버 오류');
                }

                const data = await response.json();
                finalResultTextarea.value = data.correctedText;
                finalResultTextarea.readOnly = false; // 편집 가능하게
                
                // 최종 결과물 생성 후 인쇄 버튼 활성화
                printFinalBtn.style.display = 'flex';


            } catch (e) {
                alert('최종 결과물 요청 중 오류가 발생했습니다: ' + e.message);
            } finally {
                submitFinalBtn.disabled = false;
                submitSpinnerFinal.style.display = 'none';
            }
        });


        // 피드백 제출 버튼 클릭
        submitFeedbackBtn.addEventListener('click', async () => {
            const feedbackContent = feedbackTextarea.value.trim();
            if (!feedbackContent) {
                alert('피드백 내용을 입력해주세요.');
                return;
            }

            submitFeedbackBtn.disabled = true;
            feedbackSpinner.style.display = 'block';
            feedbackResultMessage.textContent = '피드백 제출 중...';
            feedbackResultContainer.style.display = 'block';

            try {
                const response = await fetch('/api/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contentText: feedbackContent })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '알 수 없는 서버 오류');
                }

                const data = await response.json();
                feedbackResultMessage.textContent = data.message + (data.analysis ? `\n\n(AI 분석: ${data.analysis})` : '');
                feedbackTextarea.value = ''; // 피드백 제출 후 초기화

            } catch (e) {
                feedbackResultMessage.textContent = '피드백 전송 중 오류: ' + e.message;
            } finally {
                submitFeedbackBtn.disabled = false;
                feedbackSpinner.style.display = 'none';
            }
        });

        // 인쇄 관련 함수 및 이벤트 리스너
        function generateAndPrintHTML(imageUrl, printOriginal, printOcr, printCorrected, userName, userSchool, type) {
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert('팝업 차단이 되어 있습니다. 팝업을 허용해주세요.');
                return;
            }

            let ocrText = ocrResultTextarea.value;
            let correctedText = finalResultTextarea.value;
            let title = '';
            let contentToPrint = '';

            if (type === 'ocr') {
                title = 'OCR 인식 결과';
                contentToPrint = printOcr ? ocrText : '';
            } else if (type === 'final') {
                title = '최종 교정 결과';
                contentToPrint = printCorrected ? correctedText : '';
            }

            let htmlContent = `
                <!DOCTYPE html>
                <html lang="ko">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>${title}</title>
                    <style>
                        body { font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif; margin: 20mm; color: #333; line-height: 1.6; }
                        .header { text-align: center; margin-bottom: 20mm; }
                        .header h1 { font-size: 24pt; margin-bottom: 5mm; color: #4f46e5; }
                        .info { font-size: 10pt; margin-bottom: 10mm; text-align: right; }
                        .image-section { text-align: center; margin-bottom: 20mm; }
                        .image-section img { max-width: 100%; height: auto; border: 1px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
                        .text-section { margin-bottom: 20mm; border: 1px solid #eee; padding: 15mm; background-color: #f9f9f9; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word; }
                        .section-title { font-size: 14pt; font-weight: bold; margin-bottom: 10mm; border-bottom: 1px solid #ddd; padding-bottom: 5mm; color: #333; }
                        .footer { text-align: center; font-size: 9pt; color: #777; margin-top: 30mm; }
                        @page { size: A4; margin: 20mm; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>${title}</h1>
                    </div>
                    <div class="info">
                        ${userName ? `<strong>이름:</strong> ${userName}` : ''}
                        ${userSchool ? `<br><strong>학교:</strong> ${userSchool}` : ''}
                        <br><strong>인쇄 날짜:</strong> ${new Date().toLocaleDateString()}
                    </div>
                    ${printOriginal && imageUrl ? `
                        <div class="image-section">
                            <div class="section-title">원본 이미지</div>
                            <img src="${imageUrl}" alt="원본 이미지">
                        </div>
                    ` : ''}
                    ${contentToPrint ? `
                        <div class="text-section">
                            <div class="section-title">${type === 'ocr' ? 'OCR 텍스트' : '교정된 텍스트'}</div>
                            ${contentToPrint}
                        </div>
                    ` : ''}
                    <div class="footer">
                        윤선생 리얼스피치 WriteBack (비공식 자료)
                    </div>
                </body>
                </html>
            `;

            printWindow.document.open();
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            // printWindow.close(); // 인쇄 후 닫을지 여부는 UX에 따라 결정
        }

        // 인쇄 시 현재 회전된 이미지 상태를 반영하기 위한 함수
        function getRotatedImageForPrint(originalDataUrl, callback) {
            const img = new Image();
            img.src = originalDataUrl;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const rotationInRadians = currentRotation * Math.PI / 180;

                let rotatedWidth = img.naturalWidth;
                let rotatedHeight = img.naturalHeight;

                if (currentRotation % 180 !== 0) {
                    rotatedWidth = img.naturalHeight;
                    rotatedHeight = img.naturalWidth;
                }

                canvas.width = rotatedWidth;
                canvas.height = rotatedHeight;

                ctx.translate(rotatedWidth / 2, rotatedHeight / 2);
                ctx.rotate(rotationInRadians);
                ctx.drawImage(img, -img.naturalWidth / 2, -img.naturalHeight / 2);

                callback(canvas.toDataURL(originalMimeType || 'image/png'));
            };
        }


        // OCR 인쇄 버튼 이벤트
        printOcrBtn.addEventListener('click', () => {
            if (!ocrResultTextarea.value.trim() && (!imagePreview.src || imagePreview.src === '#')) {
                alert('OCR 인식을 먼저 수행하거나 이미지를 업로드해주세요.');
                return;
            }
            printOptionsOcr.style.display = 'flex'; // 옵션 표시
        });

        // OCR 인쇄 확인 버튼
        document.getElementById('confirm-print-ocr-btn').addEventListener('click', () => {
            const orig = document.getElementById('print_orig_ocr').checked;
            const ocr = document.getElementById('print_ocr').checked; // 올바른 ID: print_ocr
            const name = document.getElementById('user-name-ocr').value;
            const school = document.getElementById('user-school-ocr').value;

            printOptionsOcr.style.display = 'none'; // 옵션 숨김

            if (orig && originalImageUrl && originalImageUrl.startsWith('data:')) {
                getRotatedImageForPrint(originalImageUrl, (rotatedImageUrl) => {
                    generateAndPrintHTML(rotatedImageUrl, orig, ocr, false, name, school, 'ocr');
                });
            } else {
                generateAndPrintHTML(originalImageUrl, orig, ocr, false, name, school, 'ocr');
            }
        });

        // 최종 결과물 인쇄 버튼 이벤트
        printFinalBtn.addEventListener('click', () => {
            if (!finalResultTextarea.value.trim() && (!imagePreview.src || imagePreview.src === '#')) {
                alert('최종 결과물 생성을 먼저 수행하거나 이미지를 업로드해주세요.');
                return;
            }
            printOptionsFinal.style.display = 'flex'; // 옵션 표시
        });

        // 최종 결과물 인쇄 확인 버튼
        document.getElementById('confirm-print-final-btn').addEventListener('click', () => {
            const orig = document.getElementById('print_orig_final').checked; // 올바른 ID: print_orig_final
            const corr = document.getElementById('print_corr_final').checked; // 올바른 ID: print_corr_final
            const name = document.getElementById('user-name-final').value;
            const school = document.getElementById('user-school-final').value;

            document.getElementById('print-options-final').style.display = 'none';

            if (orig && originalImageUrl && originalImageUrl.startsWith('data:')) {
                getRotatedImageForPrint(originalImageUrl, (rotatedImageUrl) => {
                    generateAndPrintHTML(rotatedImageUrl, orig, false, corr, name, school, 'final');
                });
            } else {
                generateAndPrintHTML(originalImageUrl, orig, false, corr, name, school, 'final');
            }
        });
    </script>
</body>

</html>
